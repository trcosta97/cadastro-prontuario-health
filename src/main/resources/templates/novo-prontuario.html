<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h2>Prontuário</h2>

    <!-- Campo de Busca por CPF -->
    <div class="form-group">
        <label for="cpf">Digite o CPF do Paciente:</label>
        <input type="text" class="form-control" id="cpf" placeholder="Digite o CPF" required>
        <button type="button" class="btn btn-info mt-2" onclick="buscarPaciente()">Buscar Paciente</button>
    </div>

    <!-- Dados do Paciente (visíveis após a busca) -->
    <div id="dadosPaciente" class="mt-4" style="display:none;">
        <h5>Dados do Paciente</h5>
        <p><strong>Nome:</strong> <span id="nomePaciente"></span></p>
        <p><strong>Data de Nascimento:</strong> <span id="dataNascimento"></span></p>
        <p><strong>Sexo:</strong> <span id="sexo"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
    </div>

    <form id="prontuarioForm" class="mt-4" style="display:none;">

        <div class="form-group">
            <label for="pacienteId">ID do Paciente</label>
            <input type="number" class="form-control" id="pacienteId" readonly required>
        </div>

        <div class="form-group mt-3">
            <label for="cdProntuario">Código do Prontuário</label>
            <input type="text" class="form-control" id="cdProntuario" readonly required>
        </div>
        <div class="form-group mt-3">
            <label for="subjetivo">Subjetivo</label>
            <textarea class="form-control" id="subjetivo" rows="3"></textarea>
        </div>
        <div class="form-group mt-3">
            <label for="objetivo">Objetivo</label>
            <textarea class="form-control" id="objetivo" rows="3"></textarea>
        </div>

        <!-- Avaliação com campos específicos por perfil profissional -->
        <div class="form-group mt-3">
            <label for="avaliacao">Avaliação (Hipótese Diagnóstica)</label>
            <textarea class="form-control" id="avaliacao" rows="3"></textarea>

            <!-- Seleção do perfil profissional -->
            <div class="form-group mt-2">
                <label>Perfil Profissional:</label>
                <select class="form-select" id="perfilProfissional" onchange="atualizarCamposAvaliacao()">
                    <option value="">Selecione o perfil</option>
                    <option value="MEDICO">Médico(a)</option>
                    <option value="ENFERMEIRO">Enfermeiro(a)</option>
                    <option value="DENTISTA">Dentista</option>
                    <option value="MULTIDISCIPLINAR">Equipe Multidisciplinar</option>
                </select>
            </div>

            <!-- Campos específicos para cada perfil (inicialmente ocultos) -->
            <div id="camposMedico" class="mt-2" style="display:none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="ciap">CIAP (Classificação Internacional da Atenção Primária)*</label>
                        <input type="text" class="form-control" id="ciap">
                    </div>
                    <div class="col-md-6">
                        <label for="cip">CIP (Classificação Internacional de Procedimentos)*</label>
                        <input type="text" class="form-control" id="cip">
                    </div>
                </div>
            </div>

            <div id="camposEnfermeiro" class="mt-2" style="display:none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="ciapEnfermeiro">CIAP (Classificação Internacional da Atenção Primária)*</label>
                        <input type="text" class="form-control" id="ciapEnfermeiro">
                    </div>
                    <div class="col-md-6">
                        <label for="cipesc">CIPESC (Classificação Internacional das Práticas de Enfermagem em Saúde Coletiva)*</label>
                        <input type="text" class="form-control" id="cipesc">
                    </div>
                </div>
            </div>

            <div id="camposDentista" class="mt-2" style="display:none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="ciapDentista">CIAP (Classificação Internacional da Atenção Primária)*</label>
                        <input type="text" class="form-control" id="ciapDentista">
                    </div>
                    <div class="col-md-6">
                        <label for="cidOdontologico">CID Odontológico*</label>
                        <input type="text" class="form-control" id="cidOdontologico">
                    </div>
                </div>
            </div>

            <div id="camposMultidisciplinar" class="mt-2" style="display:none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="ciapMulti">CIAP (Classificação Internacional da Atenção Primária)*</label>
                        <input type="text" class="form-control" id="ciapMulti">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group mt-3">
            <label for="plano">Plano</label>
            <textarea class="form-control" id="plano" rows="3"></textarea>
        </div>

        <!-- Checkboxes de comorbidades -->
        <div class="form-group mt-3">
            <h5>Comorbidades e Condições:</h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="hipertensao">
                <label class="form-check-label" for="hipertensao">Hipertensão Arterial Sistêmica</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="diabetes">
                <label class="form-check-label" for="diabetes">Diabetes</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tuberculose">
                <label class="form-check-label" for="tuberculose">Tuberculose</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="hanseniase">
                <label class="form-check-label" for="hanseniase">Hanseníase</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="gestante">
                <label class="form-check-label" for="gestante">Gestante</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="puerpera">
                <label class="form-check-label" for="puerpera">Puérpera</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="saudeMental">
                <label class="form-check-label" for="saudeMental">Saúde Mental</label>
            </div>
        </div>

        <div class="form-group mt-4">
            <button type="submit" class="btn btn-primary">Salvar Prontuário</button>
        </div>
    </form>

    <!-- Alerta -->
    <div id="alert-container" class="mt-4"></div>
    <a href="/home" class="btn btn-secondary">Voltar para Home</a>
</div>

<script>
    // Verificar se temos um agendamento ativo ao carregar a página
    let agendamentoAtualId = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Verificar se há ID de agendamento armazenado no localStorage
        agendamentoAtualId = localStorage.getItem('agendamentoAtualId');

        // Verificar se temos um parâmetro de CPF na URL (vindo da página de agendamentos)
        const urlParams = new URLSearchParams(window.location.search);
        const cpfParam = urlParams.get('cpf');

        if (cpfParam) {
            // Preencher o campo de CPF e executar a busca automaticamente
            document.getElementById('cpf').value = cpfParam;
            buscarPaciente();
        }
    });

    function atualizarCamposAvaliacao() {
        const perfil = document.getElementById('perfilProfissional').value;

        // Ocultar todos os campos específicos
        document.getElementById('camposMedico').style.display = 'none';
        document.getElementById('camposEnfermeiro').style.display = 'none';
        document.getElementById('camposDentista').style.display = 'none';
        document.getElementById('camposMultidisciplinar').style.display = 'none';

        // Mostrar os campos específicos para o perfil selecionado
        if (perfil === 'MEDICO') {
            document.getElementById('camposMedico').style.display = 'block';
        } else if (perfil === 'ENFERMEIRO') {
            document.getElementById('camposEnfermeiro').style.display = 'block';
        } else if (perfil === 'DENTISTA') {
            document.getElementById('camposDentista').style.display = 'block';
        } else if (perfil === 'MULTIDISCIPLINAR') {
            document.getElementById('camposMultidisciplinar').style.display = 'block';
        }
    }

    function buscarPaciente() {
        const cpf = document.getElementById('cpf').value;
        if (!cpf) {
            alert('Digite um CPF para buscar!');
            return;
        }

        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('Token não encontrado. Faça login novamente.');
            return;
        }

        fetch(`http://localhost:8080/api/paciente/cpf/${cpf}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) throw new Error('Paciente não encontrado ou erro na requisição');
            return res.json();
        })
        .then(data => {
            document.getElementById('pacienteId').value = data.id;
            document.getElementById('cdProntuario').value = data.cdProntuario;
            document.getElementById('nomePaciente').textContent = data.nomeCompleto;
            document.getElementById('dataNascimento').textContent = data.dataNascimento;
            document.getElementById('sexo').textContent = data.sexo;
            document.getElementById('email').textContent = data.email;

            // Preenche os checkboxes com base nas condições do paciente
            document.getElementById('hipertensao').checked = data.hipertensaoArterialSistemica;
            document.getElementById('diabetes').checked = data.diabetes;
            document.getElementById('tuberculose').checked = data.tuberculose;
            document.getElementById('hanseniase').checked = data.hanseniase;
            document.getElementById('gestante').checked = data.gestante;
            document.getElementById('puerpera').checked = data.puerpera;
            document.getElementById('saudeMental').checked = data.transtornoMental;

            document.getElementById('dadosPaciente').style.display = 'block';
            document.getElementById('prontuarioForm').style.display = 'block';

            // Verificar o perfil do usuário logado e preencher automaticamente
            verificarPerfilUsuario(token);
        })
        .catch(err => {
            alert(err.message);
        });
    }

    function verificarPerfilUsuario(token) {
        fetch(`http://localhost:8080/api/usuario/me`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) throw new Error('Erro ao obter informações do usuário');
            return res.json();
        })
        .then(data => {
            // Verificar roles do usuário e selecionar o perfil correspondente
            if (data.roles) {
                const roles = data.roles.map(role => role.name);

                if (roles.includes('MEDICO')) {
                    document.getElementById('perfilProfissional').value = 'MEDICO';
                } else if (roles.includes('ENFERMEIRO')) {
                    document.getElementById('perfilProfissional').value = 'ENFERMEIRO';
                } else if (roles.includes('DENTISTA')) {
                    document.getElementById('perfilProfissional').value = 'DENTISTA';
                } else if (roles.includes('EQUIPE_MULTIDICIPLINAR')) {
                    document.getElementById('perfilProfissional').value = 'MULTIDISCIPLINAR';
                }

                // Atualizar campos visíveis
                atualizarCamposAvaliacao();
            }
        })
        .catch(err => {
            console.error('Erro ao obter perfil do usuário:', err);
        });
    }

    document.getElementById('prontuarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const token = localStorage.getItem('jwtToken');
        const pacienteId = document.getElementById('pacienteId').value;
        const cdProntuario = document.getElementById('cdProntuario').value;
        const perfil = document.getElementById('perfilProfissional').value;

        if (!perfil) {
            alert('Selecione seu perfil profissional para continuar.');
            return;
        }

        // Validar campos obrigatórios de acordo com o perfil
        let camposValidos = true;

        if (perfil === 'MEDICO') {
            if (!document.getElementById('ciap').value || !document.getElementById('cip').value) {
                alert('Os campos CIAP e CIP são obrigatórios para médicos.');
                camposValidos = false;
            }
        } else if (perfil === 'ENFERMEIRO') {
            if (!document.getElementById('ciapEnfermeiro').value || !document.getElementById('cipesc').value) {
                alert('Os campos CIAP e CIPESC são obrigatórios para enfermeiros.');
                camposValidos = false;
            }
        } else if (perfil === 'DENTISTA') {
            if (!document.getElementById('ciapDentista').value || !document.getElementById('cidOdontologico').value) {
                alert('Os campos CIAP e CID Odontológico são obrigatórios para dentistas.');
                camposValidos = false;
            }
        } else if (perfil === 'MULTIDISCIPLINAR') {
            if (!document.getElementById('ciapMulti').value) {
                alert('O campo CIAP é obrigatório para profissionais da equipe multidisciplinar.');
                camposValidos = false;
            }
        }

        if (!camposValidos) return;

        // Preparar os valores específicos conforme o perfil selecionado
        let ciapValue = '';
        let cipValue = '';
        let cipescValue = '';
        let cidOdontologicoValue = '';

        if (perfil === 'MEDICO') {
            ciapValue = document.getElementById('ciap').value;
            cipValue = document.getElementById('cip').value;
        } else if (perfil === 'ENFERMEIRO') {
            ciapValue = document.getElementById('ciapEnfermeiro').value;
            cipescValue = document.getElementById('cipesc').value;
        } else if (perfil === 'DENTISTA') {
            ciapValue = document.getElementById('ciapDentista').value;
            cidOdontologicoValue = document.getElementById('cidOdontologico').value;
        } else if (perfil === 'MULTIDISCIPLINAR') {
            ciapValue = document.getElementById('ciapMulti').value;
        }

        const prontuarioData = {
            pacienteId: +pacienteId,
            cdProntuario: +cdProntuario,
            subjetivo: document.getElementById('subjetivo').value,
            objetivo: document.getElementById('objetivo').value,
            avaliacao: document.getElementById('avaliacao').value,
            plano: document.getElementById('plano').value,
            hipertensaoArterialSistemica: document.getElementById('hipertensao').checked,
            diabetes: document.getElementById('diabetes').checked,
            tuberculose: document.getElementById('tuberculose').checked,
            hanseniase: document.getElementById('hanseniase').checked,
            gestante: document.getElementById('gestante').checked,
            puperpera: document.getElementById('puerpera').checked,
            saudeMental: document.getElementById('saudeMental').checked,
            ciap: ciapValue,
            cip: cipValue,
            cipesc: cipescValue,
            cidOdontologico: cidOdontologicoValue
        };

        fetch('http://localhost:8080/api/prontuarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(prontuarioData)
        })
        .then(res => {
            if (!res.ok) throw new Error('Erro ao salvar prontuário');
            return res.json();
        })
        .then(data => {
            // Prontuário salvo com sucesso
            mostrarAlerta('Prontuário salvo com sucesso!', 'alert-success');

            // Se tiver um agendamento associado, marcar como realizado
            if (agendamentoAtualId) {
                marcarAgendamentoComoRealizado(agendamentoAtualId, token);
            }
        })
        .catch(err => mostrarAlerta(err.message, 'alert-danger'));
    });

    // Função para marcar o agendamento como realizado
    function marcarAgendamentoComoRealizado(agendamentoId, token) {
        fetch(`http://localhost:8080/api/agendamentos/${agendamentoId}/realizado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) throw new Error('Erro ao atualizar status do agendamento');
            return res.json();
        })
        .then(data => {
            mostrarAlerta('Prontuário salvo e agendamento marcado como realizado com sucesso!', 'alert-success');
            // Limpar o ID do agendamento atual do localStorage após o uso
            localStorage.removeItem('agendamentoAtualId');
        })
        .catch(err => {
            console.error('Erro ao atualizar status do agendamento:', err);
            // Ainda mostramos que o prontuário foi salvo, mas indicamos o erro na atualização do agendamento
            mostrarAlerta('Prontuário salvo com sucesso, mas houve um erro ao atualizar o status do agendamento.', 'alert-warning');
        });
    }

    function mostrarAlerta(message, type) {
        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = `<div class="alert ${type} mt-3" role="alert">${message}</div>`;

        // Rolar para mostrar o alerta
        alertContainer.scrollIntoView({ behavior: 'smooth' });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>